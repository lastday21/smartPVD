# SmartPVD — Smart Pressure-Volume Dynamics

Инструмент для автоматизированного и системного анализа влияния нагнетательных скважин (ППД) на добывающие скважины.

---

## 1. Описание проекта

**SmartPVD** (Smart Pressure-Volume Dynamics) разработан для автоматизации задач инженеров при подготовке ремонтов и анализе добычи скважин. Система выполняет следующие функции:

* Детекция аномальных событий работы ППД;
* Построение временных окон реакции добычи на закачку;
* Расчёт количественных метрик влияния (Confidence Index, корреляции);
* Гибридная классификация партий скважин по уровню влияния;
* Подбор и оптимизация параметров алгоритма.

Цель проекта — сократить время анализа и повысить точность результатов.

---

## 2. Проблематика и задачи

1. **Ручной анализ** требует переключения между несколькими системами (NGT Smart, ШТР, Эра ремонты).
2. **Нет удержания результатов**: каждый анализ начинается с нуля.
3. **Риск ошибок** приводит к потери добычи.

**Задачи проекта:**

* Автоматизировать определение влияющих ППД;
* Сохранить результаты в базе для последующих корректировок;
* Интегрировать инструмент в систему КФА ДАРС для факторного анализа.

---

## 3. Ключевые возможности

* **Предобработка данных**: чтение Excel, нормализация форматов, интерполяция, ресемплинг.
* **Детекция PPD-событий**: выявление периодов резкого изменения дебита (порог PPD\_REL\_THRESH).
* **Формирование пар скважин**: поиск нефтяных скважин в радиусе `radius` и расчёт расстояний.
* **Построение окон отклика**: определение интервалов реакции добычи с учётом задержки и порога изменения давления.
* **Расчёт Confidence Index (CI)**: агрегирование влияния ΔQ и ΔP с учётом затухания по расстоянию.
* **Корреляционный анализ**: оценка Spearman ρ по событиям и кросс-корреляция Δ-рядов.
* **Гибридная классификация**: объединение категорий CI и корреляции с корректировками по дистанции.
* **Подбор гиперпараметров**: байесовская оптимизация Optuna (`sweep_runner.py`).

---

## 4. Архитектура и компоненты

* **config.py** — определение всех констант и пороговых значений;
* **preprocess.py** — модуль очистки и суточного ресемплинга исходных данных;
* **events\_PPD.py** — выделение событий ППД без файлового I/O и обёртка для CLI;
* **well\_pairs.py** — построение таблицы пар (нефть ↔ ППД) на основе координат;
* **window\_selector.py** — выбор границ окон реакции добычи;
* **oil\_windows.py** — формирование DataFrame окон реакции;
* **metrics.py** — расчёт детального и агрегированного CI;
* **correl.py** — корреляционный анализ и категоризация;
* **final\_mix.py** — объединение результатов CI и корреляции в итоговую метку;
* **main.py** — конвейерный скрипт: от загрузки до сохранения `final_result.csv`;
* **sweep\_runner.py** — скрипт автоматизированного перебора параметров с Optuna.

---

## 5. Требования и зависимости

* Python 3.10 или выше
* Библиотеки:

  * pandas
  * numpy
  * optuna
  * joblib

Установка зависимостей:

```bash
pip install -r requirements.txt
```

---

## 6. Установка и настройка

1. Клонировать репозиторий:

   ```bash
   git clone https://github.com/lastday21/smartPVD/
    cd SmartPVD
   ```

2. Установить зависимости:
    ```` bash
    pip install -r requirements.txt
    ````

3. Отредактировать файл `config.py` при необходимости:
   * задать к файлам с данными работы скважин;
   * задать радиус поиска `radius`;
   * установить пороги детекции событий и корреляции;
   * настроить веса CI и параметры окон отклика.

---

## 7. Структура проекта

```
SmartPVD/
├── config.py
├── main.py
├── preprocess.py
├── events_PPD.py
├── well_pairs.py
├── window_selector.py
├── oil_windows.py
├── metrics.py
├── correl.py
├── final_mix.py
├── sweep_runner.py
├── requirements.txt
├── start_data/
│   ├── Параметры ППД вынгапур 2.0.xlsx
│   ├── Параметры нефтяной вынгапур 2.0.xlsx
│   ├── Координаты2.0.xlsx
│   └── ground_truth.csv
└── clean_data/
    ├── ppd_clean.csv
    ├── oil_clean.csv
    ├── coords_clean.csv
    ├── ppd_events.csv
    ├── pairs_oil_ppd.csv
    ├── oil_windows.csv
    ├── ci_results_agg.csv
    ├── corr_results.csv
    └── final_result.csv
```

---

## 8. Запуск основного конвейера

 ```bash
    python main.py
 ```

* Все шаги выполняются последовательно;
* Промежуточные файлы сохраняются в `clean_data/` (при `DEBUG=True`);
* Итоговый отчёт — `clean_data/final_result.csv`.

---

## 9. Входные и выходные данные

* **Вход** (`start_data/`):

  * Excel-файлы с «сырыми» данными ППД, нефти и координат;
  * `ground_truth.csv` для проверки.
* **Выход** (`clean_data/`):

  * Серия CSV-файлов каждого этапа;
  * `final_result.csv` с колонками:
    `oil_well, ppd_well, distance, corr_cat, ci_cat, final_cat[, expected, acceptable]`.


---

## 10. Оценка качества

* **exact** — количество пар, где `final_cat == expected`;
* **nearby** — количество пар, где `final_cat` входит в список `acceptable`;
* **miss** — остальные;
* **accuracy** = (exact + nearby) / total.

Отчёт выводится в итоговую строку `TOTALS`.

---

## 11. Подбор параметров и эксперименты

````bash
  python sweep_runner.py
````

Результаты сохраняются в `parameters_sweeping.csv`.

---

## 12. Тестирование модулей

Каждый модуль поддерживает CLI-режим. Для проверки работоспособности:

```bash
python events_PPD.py
python oil_windows.py
python metrics.py
python correl.py
python final_mix.py
```
---
